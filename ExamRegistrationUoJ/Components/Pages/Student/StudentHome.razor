@page "/student-home"
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using ExamRegistrationUoJ.Services.DBInterfaces
@using StudentPages
@using System.Data
@using System.Security.Claims
@rendermode InteractiveServer
@attribute [Authorize(Policy = "IsStudent")]

@inject IDBServiceStudentHome db
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Home - Student</PageTitle>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (error != null)
{
    <p class="error">@error</p>
}
else if (page.departments == null || page.semesters == null)
{
    <p>Loading...</p>
}
else
{
    <h1>
        <div class="title">Published Exams</div>
        <div class="subtitle">Find an exam by:</div>
    </h1>

    <!-- Filters container -->
    <section class="filter_container">
        <!-- Department filter -->
        <div class="filter-box">
            <div class="filter-header">Department</div>
            <div class="filter-content">
                <select @onchange="async (e) => { page.departmentOpt = ((ChangeEventArgs)e).Value.ToString(); await page.filterExam(); StateHasChanged(); }" class="select-filter">
                    <option value=" "> </option>
                    @foreach (DataRow row in page.departments.Rows)
                    {
                        <option value="@row["id"]">@row["name"]</option>
                    }
                </select>
            </div>
        </div>

        <!-- Semester filter -->
        <div class="filter-box">
            <div class="filter-header">Semester</div>
            <div class="filter-content">
                <select @onchange="async (e) => { page.semesterOpt = ((ChangeEventArgs)e).Value.ToString(); await page.filterExam(); StateHasChanged(); }" class="select-filter">
                    <option value=" "> </option>
                    @foreach (DataRow row in page.semesters.Rows)
                    {
                        <option value="@row["id"]">@row["name"]</option>
                    }
                </select>
            </div>
        </div>

        <!-- Registration status filter -->
        <div class="filter-box">
            <div class="filter-header">Registration Status</div>
            <div class="filter-content">
                <select @onchange="async (e) => { page.statusOpt = ((ChangeEventArgs)e).Value.ToString(); await page.filterExam(); StateHasChanged(); }" class="select-filter">
                    <option value=" "> </option>
                    <option value="Open">Open</option>
                    <option value="Closed">Closed</option>
                </select>
            </div>
        </div>
    </section>

    <!-- Registration status containers -->
    @if (page.displayExams != null)
    {
        @foreach (DataRow row in page.displayExams.Rows)
        {
            <section class="registration-status-container">
                <div class="registration-status-box">
                    @row["name"]@row["semester"]@row["batch"] Registration Status: @row["registration_status"]
                </div>
                <div class="register-button-container">
                    <button class="register-button" @onclick="async () => await RegisterForExam(row)">Register</button>
                </div>
            </section>
        }
    }

    <!-- Your Registered Exams -->
    <div class="registered-exams">
        Your Registered Exams:
    </div>

    <!-- Exam details -->
    <div class="exam-details">
        <select class="select-exam">
            @foreach (DataRow row in page.registeredExams.Rows)
            {
                <option value="@row["id"]">@row["name"]@row["semester"]@row["batch"]</option>
            }
        </select>
    </div>
}

@code {
    private StudentHomePage page;
    private int studentId;
    private bool isLoading = true;
    private string error;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity.IsAuthenticated)
            {
                var emailClaim = user.Claims.FirstOrDefault(c => c.Type == "email" || c.Type == "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress");

                if (emailClaim != null)
                {
                    var email = emailClaim.Value;
                    var studentId = await db.getStudentIdByEmail(email);
                    if (studentId == null)
                    {
                        throw new Exception("Student ID not found for the provided email.");
                    }
                    page = new StudentHomePage(db, studentId.Value);
                    await page.Init();
                }
                else
                {
                    throw new Exception("Email claim not found.");
                }
            }
            else
            {
                error = "User is not authenticated.";
            }
        }
        catch (Exception ex)
        {
            error = $"An error occurred: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task RegisterForExam(DataRow exam)
    {
        try
        {
            int examId = (int)exam["id"];
            bool result = await page.RegisterForExam(examId);

            if (result)
            {
                NavigationManager.NavigateTo($"/exam-registration-confirmation/{examId}");
            }
            else
            {
                error = "Failed to register for the exam.";
            }
        }
        catch (Exception ex)
        {
            error = $"An error occurred: {ex.Message}";
        }
    }

    public class StudentHomePage
    {
        private readonly IDBServiceStudentHome db;
        private readonly int studentId;

        public DataTable departments { get; private set; }
        public DataTable semesters { get; private set; }
        public DataTable displayExams { get; private set; }
        public DataTable registeredExams { get; private set; }

        public string departmentOpt { get; set; }
        public string semesterOpt { get; set; }
        public string statusOpt { get; set; }

        public StudentHomePage(IDBServiceStudentHome db, int studentId)
        {
            this.db = db;
            this.studentId = studentId;
        }

        public async Task Init()
        {
            try
            {
                departments = await db.getDepartments();
                semesters = await db.getSemesters();
                displayExams = await db.getExams();
                registeredExams = await db.getRegisteredExams(studentId);
            }
            catch (Exception ex)
            {
                throw new Exception($"Failed to initialize page: {ex.Message}");
            }
        }

        public async Task filterExam()
        {
            try
            {
                displayExams = await db.getFilteredExams(int.Parse(departmentOpt), int.Parse(semesterOpt), int.Parse(statusOpt));
            }
            catch (Exception ex)
            {
                throw new Exception($"Failed to filter exams: {ex.Message}");
            }
        }

        public async Task<bool> RegisterForExam(int examId)
        {
            try
            {
                return await db.registerForExam(studentId, examId);
            }
            catch (Exception ex)
            {
                throw new Exception($"Failed to register for exam: {ex.Message}");
            }
        }
    }
}